<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glomo - Your Details</title>

  <link rel="stylesheet" href="css/bulma.min.css">
  <link rel="stylesheet" href="css/main.css">

  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
  <link rel="icon" type="image/png" href="favicon.png" sizes="16x16">
</head>

<body class="page">
  <section class="section glomo-wrap">
    <div class="container">
      <div class="glomo-card">

        <!-- App bar -->
        <div class="appbar">
          <div class="appbar__left">
            <a class="appbar__back" href="index.html" data-nav="back" aria-label="Back"><img class="icon-medium" src="assets/icons/arrow-left.svg" alt=""></a>
          </div>
          <div class="appbar__center">
            <img src="glomo-logo.png" class="appbar__logo" alt="Glomo">
          </div>
          <div class="appbar__right"></div>
        </div>

        <!-- Progress bar -->
        <div class="appbar-progress">
          <div class="appbar-progress__bar" data-progress="50"></div>
        </div>

        <div class="glomo-card__top">
          <div>
            <div class="step-indicator">Step 1 of 2</div>
            <h1 class="title is-6 mb-2">Fill your details</h1>
            <p class="subtitle is-7 mb-2">
                Below information helps us connect with you on WhatsApp, handle your orders conveniently, and ensure fast doorstep delivery.
            </p>
          </div>
        </div>

        <div class="glomo-card__body">
          <form id="step1Form">
            <div class="columns is-multiline mt-1">
              <div class="column is-12">
                <label class="label">Name</label>
                <input id="nameField" class="input" type="text" name="customer_name" autocomplete="name" placeholder="" required>
              </div>

              <div class="column is-12">
                <label class="label">WhatsApp number</label>
                <input id="waField" class="input" type="tel" name="customer_whatsapp" autocomplete="tel" inputmode="tel" placeholder="" required>
                <p class="help">We’ll send your basket link on WhatsApp.</p>
              </div>

              <div class="column is-12">
                <label class="label">Delivery address</label>
                <input id="addressField" class="input" name="customer_address" autocomplete="street-address" placeholder="House number, street" required>
              </div>

              <div class="column is-12">
                <label class="label">City</label>
                <div class="ac-wrap">
                  <input id="cityField" class="input" type="text" name="customer_city" autocomplete="off" placeholder="Start typing your city" required>
                  <div class="ac-menu" id="cityMenu" role="listbox" aria-label="City suggestions"></div>
                </div>
              </div>
            </div>

            <div class="columns is-vcentered mt-5">
              <div class="column is-12">
                <button class="button is-medium btn-gradient is-fullwidth" type="submit">
                  Next
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <a href="https://glomo.lk" target="_blank" class="copyright has-text-centered mt-4 fineprint">
        © Glomo.lk
      </a>
    </div>
  </section>

  <script>
    // ----- Progress bar animate -----
    const bar = document.querySelector(".appbar-progress__bar");
    requestAnimationFrame(() => {
      if (bar) bar.style.width = (bar.dataset.progress || "0") + "%";
    });

    // ----- Slide entry direction -----
    const dir = sessionStorage.getItem("glomo_nav_dir") || "forward";
    document.body.classList.add(dir === "back" ? "enter-left" : "enter-right");

    // ----- Intercept back link for exit animation -----
    document.querySelectorAll("a[data-nav]").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const nav = a.dataset.nav; // back | forward
        sessionStorage.setItem("glomo_nav_dir", nav);

        document.body.classList.add(nav === "back" ? "exit-left" : "exit-right");
        setTimeout(() => window.location.href = a.href, 200);
      });
    });

    // ----- Step data storage -----
    const KEY = "glomo_earlybird";

    function readDraft() {
      try { return JSON.parse(sessionStorage.getItem(KEY) || "{}"); }
      catch { return {}; }
    }
    function writeDraft(d) {
      sessionStorage.setItem(KEY, JSON.stringify(d || {}));
    }

    const draft = readDraft();
    const nameField = document.getElementById("nameField");
    const waField = document.getElementById("waField");
    const addressField = document.getElementById("addressField");
    const cityField = document.getElementById("cityField");
    const cityMenu = document.getElementById("cityMenu");
    let CITIES = [];
    let citySuggestions = [];
    let cityActiveIndex = -1;

    function cityLabel(item) {
      return `${item.city} (${item.code})`;
    }

    function openMenu(menuEl) { menuEl?.classList.add("is-active"); }
    function closeMenu(menuEl) { menuEl?.classList.remove("is-active"); }

    function cityScore(item, q) {
      const city = item.city.toLowerCase();
      const code = String(item.code);
      if (city === q) return 0;
      if (city.startsWith(q)) return 1;
      if (city.split(/\\s+/).some((word) => word.startsWith(q))) return 2;
      if (code.startsWith(q)) return 3;
      if (city.includes(q)) return 4;
      if (code.includes(q)) return 5;
      return 99;
    }

    function filterCities(query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) return CITIES.slice(0, 30);
      return CITIES
        .map((x) => ({ item: x, score: cityScore(x, q) }))
        .filter((x) => x.score < 99)
        .sort((a, b) => {
          if (a.score !== b.score) return a.score - b.score;
          if (a.item.city.length !== b.item.city.length) return a.item.city.length - b.item.city.length;
          return Number(a.item.code) - Number(b.item.code);
        })
        .slice(0, 30)
        .map((x) => x.item);
    }

    function renderCityMenu(items) {
      cityMenu.innerHTML = "";
      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "ac-empty";
        empty.textContent = "No suggestions found.";
        cityMenu.appendChild(empty);
        return;
      }

      items.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "ac-item";
        if (idx === cityActiveIndex) div.classList.add("is-active");
        div.setAttribute("role", "option");
        div.textContent = cityLabel(item);
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          chooseCity(item);
        });
        cityMenu.appendChild(div);
      });
    }

    function refreshCityMenu(openIfNeeded = true) {
      citySuggestions = filterCities(cityField.value);
      if (cityActiveIndex >= citySuggestions.length) cityActiveIndex = -1;
      renderCityMenu(citySuggestions);
      if (openIfNeeded) openMenu(cityMenu);
    }

    function chooseCity(item) {
      cityField.value = cityLabel(item);
      cityField.dataset.code = item.code;
      cityField.dataset.city = item.city;
      cityField.setCustomValidity("");
      closeMenu(cityMenu);
      cityActiveIndex = -1;
    }

    function markCityUnselected() {
      delete cityField.dataset.code;
      delete cityField.dataset.city;
    }

    function resolveCityFromValue(rawValue) {
      const v = (rawValue || "").trim().toLowerCase();
      if (!v) return null;
      return CITIES.find((x) => cityLabel(x).toLowerCase() === v || x.city.toLowerCase() === v) || null;
    }

    async function loadCities() {
      try {
        const res = await fetch("cities.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load cities.json");
        const data = await res.json();
        CITIES = Array.isArray(data)
          ? data
              .filter((x) => x && x.city && x.code)
              .sort((a, b) => {
                const aCode = Number(a.code);
                const bCode = Number(b.code);
                return aCode - bCode;
              })
          : [];
      } catch (err) {
        console.warn(err);
        CITIES = [];
      }
    }

    cityField.addEventListener("focus", () => {
      cityActiveIndex = -1;
      refreshCityMenu(true);
    });
    cityField.addEventListener("input", () => {
      markCityUnselected();
      cityField.setCustomValidity("");
      cityActiveIndex = -1;
      refreshCityMenu(true);
    });
    cityField.addEventListener("blur", () => {
      const matched = resolveCityFromValue(cityField.value);
      if (matched) {
        chooseCity(matched);
      } else {
        cityField.setCustomValidity("Please select a city from the suggestions.");
      }
      setTimeout(() => closeMenu(cityMenu), 120);
    });
    cityField.addEventListener("keydown", (e) => {
      if (!cityMenu.classList.contains("is-active")) return;
      if (e.key === "ArrowDown") {
        e.preventDefault();
        cityActiveIndex = Math.min(cityActiveIndex + 1, citySuggestions.length - 1);
        renderCityMenu(citySuggestions);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        cityActiveIndex = Math.max(cityActiveIndex - 1, 0);
        renderCityMenu(citySuggestions);
      } else if (e.key === "Enter" && cityActiveIndex >= 0) {
        e.preventDefault();
        chooseCity(citySuggestions[cityActiveIndex]);
      } else if (e.key === "Escape") {
        closeMenu(cityMenu);
      }
    });

    document.addEventListener("mousedown", (e) => {
      const wrap = cityMenu.closest(".ac-wrap");
      if (wrap && !wrap.contains(e.target)) closeMenu(cityMenu);
    });

    if (draft.customer_name) nameField.value = draft.customer_name;
    if (draft.customer_whatsapp) waField.value = draft.customer_whatsapp;
    if (draft.customer_address) addressField.value = draft.customer_address;
    if (draft.customer_city) cityField.value = draft.customer_city;

    document.getElementById("step1Form").addEventListener("submit", (e) => {
      e.preventDefault();

      const selectedCity = resolveCityFromValue(cityField.value);
      if (!selectedCity) {
        cityField.setCustomValidity("Please select a city from the suggestions.");
        cityField.reportValidity();
        cityField.focus();
        return;
      }
      chooseCity(selectedCity);

      writeDraft({
        ...draft,
        customer_name: nameField.value.trim(),
        customer_whatsapp: waField.value.trim(),
        customer_address: addressField.value.trim(),
        customer_city: cityLabel(selectedCity)
      });

      // forward direction + exit anim
      sessionStorage.setItem("glomo_nav_dir", "forward");
      document.body.classList.add("exit-right");

      setTimeout(() => window.location.href = "your-products.html", 200);
    });

    loadCities().then(() => {
      if (draft.customer_city) {
        const matched = resolveCityFromValue(draft.customer_city);
        if (matched) chooseCity(matched);
      }
    });
  </script>
</body>
</html>
