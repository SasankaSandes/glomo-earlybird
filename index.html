<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glomo Earlybird â€“ Curated Basket</title>

  <!-- Bulma -->
  <link rel="stylesheet" href="css/bulma.min.css">
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <section class="section glomo-wrap">
    <div class="container" style="max-width: 920px;">
      <div class="glomo-card">
        <div class="glomo-card__top">
          <div class="brand-row">
            <div class="brand-mark" title="Glomo">
              <!-- Replace src with your hosted logo path (example: /assets/glomo-square-logo.png) -->
              <img src="glomo-square-logo.png" alt="Glomo logo">
            </div>
            <div>
              <h1 class="title is-4 mb-1" style="color:var(--text);">Earlybird Curated Basket</h1>
              <p class="subtitle is-6 mb-0">
                Tell us what you already use. Weâ€™ll curate a basket you can order &amp; reorder anytime.
              </p>
            </div>
          </div>
        </div>

        <div class="glomo-card__body">
          <form id="earlybirdForm" action="#" method="post" enctype="multipart/form-data">
            <!-- Customer details -->
            <div class="columns is-multiline">
              <div class="column is-12">
                <label class="label">Full name</label>
                <input class="input" type="text" name="customer_name" placeholder="Your name" required>
              </div>
              <div class="column is-12">
                <label class="label">WhatsApp number</label>
                <input class="input" type="tel" name="customer_whatsapp" placeholder="e.g. +94 77 123 4567" required>
                <p class="help">Weâ€™ll message your curated basket link here.</p>
              </div>
            </div>

            <hr style="border-color: var(--line);">

            <!-- Products -->
            <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
              <div>
                <h2 class="title is-5 mb-1" style="color:var(--text);">Add your favourite products</h2>
                <p class="fineprint">Brand + Name + Size (Images optional). Add as many as you want.</p>
              </div>
            </div>

            <div id="productsWrap" class="block" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Product rows injected here -->
            </div>
            <button type="button" id="addProductBtn" class="button btn-ghost">
                + Add another product
              </button>

            <hr style="border-color: var(--line);">

            <div class="columns is-vcentered">
              <div class="column is-12">
                <p class="fineprint">
                  MVP note: After we build your first basket, you can request changes anytime (swap items, sizes, add/remove products).
                </p>
              </div>
              <div class="column is-12 has-text-right">
                <button type="submit" class="button is-medium btn-gradient is-fullwidth">
                  Submit &amp; Get My Basket
                </button>
              </div>
            </div>

          </form>
        </div>
      </div>

      <p class="has-text-centered mt-4 fineprint">
        Â© Glomo.lk â€¢ Black &amp; white minimal â€¢ Logo-accent gradient
      </p>
    </div>
  </section>

  <template id="productRowTpl">
    <div class="product-block">
      <div class="product-block__head">
        <span class="tag is-dark">Product <span class="product-index"></span></span>
        <button type="button" class="button is-small btn-danger-ghost remove-btn">Remove</button>
      </div>

      <div class="columns is-multiline is-variable is-2">
        <div class="column is-12">
          <label class="label">Brand</label>
          <input class="input brand-input" type="text" name="products[IDX][brand]" placeholder="e.g. Beauty of Joseon" required list="brandList-IDX">
          <datalist id="brandList-IDX"></datalist>
        </div>

        <div class="column is-12">
          <label class="label">Product name</label>
          <input class="input product-input" type="text" name="products[IDX][name]" placeholder="e.g. Relief Sun: Rice + Probiotics" required list="productList-IDX">
          <datalist id="productList-IDX"></datalist>
        </div>

        <div class="column is-12">
          <label class="label">Size</label>
          <input class="input" type="text" name="products[IDX][size]" placeholder="e.g. 50ml / 200ml" required>
        </div>

        <div class="column is-12">
          <label class="label">Image (optional)</label>
          <div class="file has-name is-fullwidth">
            <label class="file-label">
              <input class="file-input img-input" type="file" name="products[IDX][image]" accept="image/*">
              <span class="file-cta btn-ghost">
                <span class="file-icon">ðŸ“·</span>
                <span class="file-label">Choose image</span>
              </span>
              <span class="file-name">No file selected</span>
            </label>
          </div>
          <p class="help">Screenshot from your gallery is perfect.</p>
        </div>

        <div class="column is-12">
          <label class="label">Preview</label>
          <div class="thumb">Optional</div>
        </div>
      </div>
    </div>
  </template>

  <script>
    const productsWrap = document.getElementById("productsWrap");
    const addBtn = document.getElementById("addProductBtn");
    const tpl = document.getElementById("productRowTpl");

    // --- Autocomplete data (brands + products) ---
    // Expects brands-and-products.json to be served from the same directory as this HTML.
    let BRAND_PRODUCTS = {};
    let BRAND_LIST = [];
    const BRAND_LOOKUP = new Map(); // lowercased brand -> canonical brand

    function canonicalBrand(input) {
      const key = (input || "").trim().toLowerCase();
      return BRAND_LOOKUP.get(key) || null;
    }

    function setDatalistOptions(datalistEl, values) {
      if (!datalistEl) return;
      datalistEl.innerHTML = "";
      (values || []).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        datalistEl.appendChild(opt);
      });
    }

    async function loadBrandProducts() {
      try {
        const res = await fetch("brands-and-products.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load brands-and-products.json");
        BRAND_PRODUCTS = await res.json();

        BRAND_LIST = Object.keys(BRAND_PRODUCTS).sort((a,b) => a.localeCompare(b));
        BRAND_LOOKUP.clear();
        BRAND_LIST.forEach(b => BRAND_LOOKUP.set(b.toLowerCase(), b));

        // Populate existing rows (if any)
        [...productsWrap.children].forEach(block => setupAutocompleteForRow(block));
      } catch (err) {
        console.warn(err);
        // If JSON fails to load, form still works normally (no suggestions).
      }
    }

    function setupAutocompleteForRow(block) {
      if (!block) return;

      const brandInput = block.querySelector(".brand-input");
      const productInput = block.querySelector(".product-input");

      // The datalists are inside the block; list="" points to their IDs
      const brandListId = brandInput?.getAttribute("list");
      const productListId = productInput?.getAttribute("list");

      const brandDatalist = brandListId ? document.getElementById(brandListId) : null;
      const productDatalist = productListId ? document.getElementById(productListId) : null;

      // Brand suggestions (always the full brand list)
      if (BRAND_LIST.length) setDatalistOptions(brandDatalist, BRAND_LIST);

      function refreshProductSuggestions() {
        const selectedBrand = canonicalBrand(brandInput.value);
        if (!selectedBrand) {
          // No matching brand selected/typed; show no brand-linked product suggestions
          setDatalistOptions(productDatalist, []);
          return;
        }

        const products = (BRAND_PRODUCTS[selectedBrand] || [])
          .map(p => p.product_name)
          .filter(Boolean);

        // Deduplicate + sort
        const unique = [...new Set(products)].sort((a,b) => a.localeCompare(b));
        setDatalistOptions(productDatalist, unique);
      }

      // Update product suggestions as brand changes (typing or choosing from dropdown)
      if (brandInput) {
        brandInput.addEventListener("input", refreshProductSuggestions);
        brandInput.addEventListener("change", refreshProductSuggestions);
      }

      // Initialize suggestions for prefilled values (if any)
      refreshProductSuggestions();
    }

    // Add 1 default row
    addProductRow();

    addBtn.addEventListener("click", () => addProductRow());

    function addProductRow() {
      const idx = productsWrap.children.length;
      const node = tpl.content.cloneNode(true);

      // Set index label + input names
      const block = node.querySelector(".product-block");
      block.querySelector(".product-index").textContent = (idx + 1);

      // Replace IDX in all name attributes + datalist IDs + list attributes
      // (keep everything else the same)
      block.querySelectorAll("[name]").forEach(el => {
        el.name = el.name.replaceAll("IDX", idx);
      });
      block.querySelectorAll("datalist[id]").forEach(el => {
        el.id = el.id.replaceAll("IDX", idx);
      });
      block.querySelectorAll("input[list]").forEach(el => {
        el.setAttribute("list", el.getAttribute("list").replaceAll("IDX", idx));
      });

      // Remove handler
      block.querySelector(".remove-btn").addEventListener("click", () => {
        block.remove();
        reindexRows();
      });

      // Image preview handler
      const imgInput = block.querySelector(".img-input");
      const fileNameEl = block.querySelector(".file-name");
      const thumb = block.querySelector(".thumb");

      imgInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        fileNameEl.textContent = file ? file.name : "No file selected";

        if (!file) {
          thumb.innerHTML = "Optional";
          return;
        }

        const url = URL.createObjectURL(file);
        thumb.innerHTML = `<img src="${url}" alt="Product image preview">`;
      });

      productsWrap.appendChild(node);

      // Attach autocomplete to the newly added row (if data is loaded)
      const addedBlock = productsWrap.lastElementChild;
      setupAutocompleteForRow(addedBlock);
    }

    function reindexRows() {
      [...productsWrap.children].forEach((block, newIdx) => {
        block.querySelector(".product-index").textContent = (newIdx + 1);

        // Update input names: products[old] -> products[new]
        block.querySelectorAll("[name]").forEach(el => {
          el.name = el.name.replace(/products\\[\\d+\\]/, `products[${newIdx}]`);
        });

        // Update datalist IDs + input list attributes to stay unique and aligned per row
        const brandInput = block.querySelector(".brand-input");
        const productInput = block.querySelector(".product-input");
        const brandDatalist = block.querySelector("datalist[id^='brandList-']");
        const productDatalist = block.querySelector("datalist[id^='productList-']");

        if (brandDatalist) brandDatalist.id = `brandList-${newIdx}`;
        if (productDatalist) productDatalist.id = `productList-${newIdx}`;

        if (brandInput) brandInput.setAttribute("list", `brandList-${newIdx}`);
        if (productInput) productInput.setAttribute("list", `productList-${newIdx}`);

        // Refresh autocomplete bindings/content for this row
        setupAutocompleteForRow(block);
      });
    }

    // Optional: handle submit (for MVP you can POST to your backend / form service)
    document.getElementById("earlybirdForm").addEventListener("submit", (e) => {
      e.preventDefault();

      // Quick MVP: show a nice confirmation
      // Replace this with: fetch('/api/earlybird', {method:'POST', body:new FormData(e.target)})
      alert("Thanks! We received your favourites. Weâ€™ll WhatsApp you your curated basket link soon.");
      e.target.reset();

      // reset UI to 1 row
      productsWrap.innerHTML = "";
      addProductRow();
    });

    // Load JSON once at startup
    loadBrandProducts();
  </script>
</body>
</html>
