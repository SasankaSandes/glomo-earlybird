<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glomo – Step 2</title>

  <link rel="stylesheet" href="css/bulma.min.css">
  <link rel="stylesheet" href="css/main.css">

  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
  <link rel="icon" type="image/png" href="favicon.png" sizes="16x16">
</head>

<body class="page">
  <section class="glomo-wrap">
    <div class="container">
      <div class="glomo-card">

        <!-- App bar -->
        <div class="appbar">
          <div class="appbar__left">
            <a class="appbar__back" href="your-details.html" data-nav="back" aria-label="Back">←</a>
          </div>
          <div class="appbar__center">
            <img src="glomo-logo.png" class="appbar__logo" alt="Glomo">
          </div>
          <div class="appbar__right"></div>
        </div>

        <!-- Progress bar -->
        <div class="appbar-progress">
          <div class="appbar-progress__bar" data-progress="100"></div>
        </div>

        <div class="glomo-card-body">
          <div>
            <div class="step-indicator">Step 2 of 2</div>
            <h1 class="title is-6 mb-2">Your favourites</h1>
            <p class="subtitle is-7 mb-2">
              Add your favourite products. We’ll create a personalised basket just for you.
            </p>
            <p class="fineprint">
              Ordering later will feel as easy as sending a WhatsApp message.
            </p>
          </div>
          <form id="earlybirdForm" action="#" method="post" enctype="multipart/form-data">
            <!-- Hidden fields filled from sessionStorage -->
            <input type="hidden" name="customer_name" id="hiddenName">
            <input type="hidden" name="customer_whatsapp" id="hiddenWhatsapp">
            <input type="hidden" name="customer_address" id="hiddenAddress">
            <input type="hidden" name="customer_city" id="hiddenCity">

            <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
              <div>
                <h2 class="title is-6 mb-1" style="color:var(--text);">Your products</h2>
                <p class="fineprint">Add products by brand. You can add as many as you want.</p>
              </div>
            </div>

            <div id="brandCards" class="block" style="display:flex; flex-direction:column; gap:12px;"></div>

            <button type="button" id="openOverlayBtn" class="button btn-ghost">
              + Add a product
            </button>

            <div class="columns is-vcentered mt-5">
              <div class="column is-12">
                <p class="fineprint">
                  After we create your personalised basket, you can request changes anytime (add/remove products and change sizes).
                </p>
              </div>

              <div class="column is-12">
                <button type="submit" class="button is-medium btn-gradient is-fullwidth">
                  Create my personalised basket
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <a href="https://glomo.lk" target="_blank" class="copyright has-text-centered mt-4 fineprint">
        © Glomo.lk
      </a>
    </div>
  </section>

  <!-- Full-screen overlay for add product -->
  <div id="addOverlay" class="overlay" aria-hidden="true">
    <div class="overlay__sheet" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlay__top">
        <button type="button" class="button is-small btn-ghost" id="closeOverlayBtn">Close</button>
        <div class="overlay__title" id="overlayTitle">Add a product</div>
        <div style="width:64px"></div>
      </div>

      <div class="overlay__body">
        <div class="field">
          <label class="label">Brand</label>
          <div class="ac-wrap">
            <input id="overlayBrand" class="input" type="text" placeholder="Search brand" autocomplete="off" />
            <div class="ac-menu" id="overlayBrandMenu" role="listbox" aria-label="Brand suggestions"></div>
          </div>
        </div>

        <div class="field">
          <label class="label">Product name</label>
          <div class="ac-wrap">
            <input id="overlayProduct" class="input" type="text" placeholder="Search product" autocomplete="off" />
            <div class="ac-menu" id="overlayProductMenu" role="listbox" aria-label="Product suggestions"></div>
          </div>
        </div>

        <div class="field">
          <label class="label">Size</label>
          <input id="overlaySize" class="input" type="text" placeholder="e.g. 50ml / 200ml" />
        </div>

        <button type="button" id="addToBrandBtn" class="button is-medium btn-gradient is-fullwidth mt-3">
          Add this product
        </button>

        <p class="fineprint mt-3">Tip: Add one product at a time. You can keep adding more brands.</p>
      </div>
    </div>
  </div>

  <template id="brandCardTpl">
    <div class="product-block brand-card">
      <div class="product-block__head">
        <span class="tag is-dark brand-title"></span>
        <button type="button" class="button is-small btn-danger-ghost remove-brand">Remove</button>
      </div>
      <div class="brand-products"></div>
    </div>
  </template>

  <template id="brandProductTpl">
    <div class="brand-product-row">
      <div class="brand-product-name"></div>
      <div class="brand-product-size"></div>
    </div>
  </template>

  <script>
    // ----- Progress bar animate -----
    const bar = document.querySelector(".appbar-progress__bar");
    requestAnimationFrame(() => {
      if (bar) bar.style.width = (bar.dataset.progress || "0") + "%";
    });

    // ----- Slide entry direction -----
    const dir = sessionStorage.getItem("glomo_nav_dir") || "forward";
    document.body.classList.add(dir === "back" ? "enter-left" : "enter-right");

    // ----- Intercept back link for exit animation -----
    document.querySelectorAll("a[data-nav]").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const nav = a.dataset.nav;
        sessionStorage.setItem("glomo_nav_dir", nav);

        document.body.classList.add(nav === "back" ? "exit-left" : "exit-right");
        setTimeout(() => window.location.href = a.href, 200);
      });
    });

    // --- Step data storage ---
    const KEY = "glomo_earlybird";
    function readDraft() {
      try { return JSON.parse(sessionStorage.getItem(KEY) || "{}"); }
      catch { return {}; }
    }

    const draft = readDraft();
    if (!draft.customer_name || !draft.customer_whatsapp || !draft.customer_address || !draft.customer_city) {
      sessionStorage.setItem("glomo_nav_dir", "back");
      window.location.href = "your-details.html";
    }

    document.getElementById("hiddenName").value = draft.customer_name || "";
    document.getElementById("hiddenWhatsapp").value = draft.customer_whatsapp || "";
    document.getElementById("hiddenAddress").value = draft.customer_address || "";
    document.getElementById("hiddenCity").value = draft.customer_city || "";

    // --- Products + autocomplete data ---
    let BRAND_PRODUCTS = {};
    let BRAND_LIST = [];
    const BRAND_LOOKUP = new Map();
    let dataLoaded = false;

    function canonicalBrand(input) {
      const key = (input || "").trim().toLowerCase();
      return BRAND_LOOKUP.get(key) || null;
    }

    function uniqSorted(arr) {
      return [...new Set(arr)].sort((a, b) => a.localeCompare(b));
    }

    async function loadBrandProducts() {
      try {
        const res = await fetch("brands-and-products.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load brands-and-products.json");
        BRAND_PRODUCTS = await res.json();
        BRAND_LIST = Object.keys(BRAND_PRODUCTS).sort((a, b) => a.localeCompare(b));
        BRAND_LOOKUP.clear();
        BRAND_LIST.forEach(b => BRAND_LOOKUP.set(b.toLowerCase(), b));
        dataLoaded = true;
      } catch (err) {
        console.warn(err);
        dataLoaded = false;
      }
    }

    function filterList(list, query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) return list.slice(0, 30);
      return list.filter(x => x.toLowerCase().includes(q)).slice(0, 30);
    }

    function productsForBrand(brandValue) {
      const b = canonicalBrand(brandValue);
      if (!b) return [];
      const raw = (BRAND_PRODUCTS[b] || []).map(p => p.product_name).filter(Boolean);
      return uniqSorted(raw);
    }

    // --- Overlay + keyboard friendly autocomplete ---
    const overlay = document.getElementById("addOverlay");
    const openOverlayBtn = document.getElementById("openOverlayBtn");
    const closeOverlayBtn = document.getElementById("closeOverlayBtn");
    const brandInput = document.getElementById("overlayBrand");
    const productInput = document.getElementById("overlayProduct");
    const sizeInput = document.getElementById("overlaySize");
    const brandMenu = document.getElementById("overlayBrandMenu");
    const productMenu = document.getElementById("overlayProductMenu");
    const addToBrandBtn = document.getElementById("addToBrandBtn");

    function openOverlay() {
      overlay.classList.add("is-active");
      overlay.setAttribute("aria-hidden", "false");
      brandInput.focus();
    }

    function closeOverlay() {
      overlay.classList.remove("is-active");
      overlay.setAttribute("aria-hidden", "true");
      brandInput.value = "";
      productInput.value = "";
      sizeInput.value = "";
      closeMenu(brandMenu);
      closeMenu(productMenu);
    }

    openOverlayBtn.addEventListener("click", openOverlay);
    closeOverlayBtn.addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeOverlay();
    });

    function openMenu(menuEl) { menuEl?.classList.add("is-active"); }
    function closeMenu(menuEl) { menuEl?.classList.remove("is-active"); }

    function renderMenu(menuEl, items, onPick, state) {
      if (!menuEl) return;
      menuEl.innerHTML = "";
      if (!items || items.length === 0) {
        const empty = document.createElement("div");
        empty.className = "ac-empty";
        empty.textContent = "No suggestions — you can type your own.";
        menuEl.appendChild(empty);
        return;
      }

      items.slice(0, 30).forEach((label, idx) => {
        const div = document.createElement("div");
        div.className = "ac-item";
        div.setAttribute("role", "option");
        div.textContent = label;
        if (state && idx === state.activeIndex) div.classList.add("is-active");

        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(label);
        });

        menuEl.appendChild(div);
      });
    }

    function makeKeyboardMenu(inputEl, menuEl, getItems, onPick) {
      const state = { activeIndex: -1, items: [] };

      function refresh(openIfNeeded = true) {
        state.items = getItems();
        if (state.activeIndex >= state.items.length) state.activeIndex = -1;
        renderMenu(menuEl, state.items, onPick, state);
        if (openIfNeeded) openMenu(menuEl);
      }

      inputEl.addEventListener("focus", () => refresh(true));
      inputEl.addEventListener("input", () => { state.activeIndex = -1; refresh(true); });
      inputEl.addEventListener("blur", () => setTimeout(() => closeMenu(menuEl), 120));

      inputEl.addEventListener("keydown", (e) => {
        if (!menuEl.classList.contains("is-active")) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          state.activeIndex = Math.min(state.activeIndex + 1, state.items.length - 1);
          renderMenu(menuEl, state.items, onPick, state);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          state.activeIndex = Math.max(state.activeIndex - 1, 0);
          renderMenu(menuEl, state.items, onPick, state);
        } else if (e.key === "Enter") {
          if (state.activeIndex >= 0) {
            e.preventDefault();
            onPick(state.items[state.activeIndex]);
          }
        } else if (e.key === "Escape") {
          closeMenu(menuEl);
        }
      });

      return { refresh };
    }

    const brandMenuState = makeKeyboardMenu(
      brandInput,
      brandMenu,
      () => filterList(BRAND_LIST, brandInput.value),
      (picked) => {
        brandInput.value = picked;
        closeMenu(brandMenu);
        productMenuState.refresh(true);
        productInput.focus();
      }
    );

    const productMenuState = makeKeyboardMenu(
      productInput,
      productMenu,
      () => filterList(productsForBrand(brandInput.value), productInput.value),
      (picked) => {
        productInput.value = picked;
        closeMenu(productMenu);
        sizeInput.focus();
      }
    );

    document.addEventListener("mousedown", (e) => {
      document.querySelectorAll(".ac-menu.is-active").forEach(menu => {
        const wrap = menu.closest(".ac-wrap");
        if (wrap && !wrap.contains(e.target)) closeMenu(menu);
      });
    });

    // --- Brand grouping render ---
    const brandCards = document.getElementById("brandCards");
    const brandCardTpl = document.getElementById("brandCardTpl");
    const brandProductTpl = document.getElementById("brandProductTpl");
    const basket = new Map();

    function renderBasket() {
      brandCards.innerHTML = "";
      [...basket.entries()].forEach(([brand, items]) => {
        const node = brandCardTpl.content.cloneNode(true);
        const card = node.querySelector(".brand-card");
        const title = node.querySelector(".brand-title");
        const list = node.querySelector(".brand-products");
        const removeBtn = node.querySelector(".remove-brand");

        title.textContent = brand;
        removeBtn.addEventListener("click", () => {
          basket.delete(brand);
          renderBasket();
        });

        items.forEach(item => {
          const row = brandProductTpl.content.cloneNode(true);
          row.querySelector(".brand-product-name").textContent = item.name;
          row.querySelector(".brand-product-size").textContent = item.size || "—";
          list.appendChild(row);
        });

        brandCards.appendChild(card);
      });
    }

    function addProductToBasket() {
      const rawBrand = brandInput.value.trim();
      const brand = canonicalBrand(rawBrand) || rawBrand;
      const name = productInput.value.trim();
      const size = sizeInput.value.trim();

      if (!brand || !name) {
        brandInput.focus();
        return;
      }

      if (!basket.has(brand)) basket.set(brand, []);
      basket.get(brand).push({ name, size });
      renderBasket();
      closeOverlay();
    }

    addToBrandBtn.addEventListener("click", addProductToBasket);
    sizeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addProductToBasket();
      }
    });

    // Submit MVP
    document.getElementById("earlybirdForm").addEventListener("submit", (e) => {
      e.preventDefault();
      sessionStorage.setItem("glomo_nav_dir", "forward");
      document.body.classList.add("exit-right");

      setTimeout(() => {
        alert("Thanks! We received your favourites. We’ll WhatsApp you your curated basket link soon.");
        sessionStorage.removeItem(KEY);
        window.location.href = "index.html";
      }, 200);
    });

    loadBrandProducts();
  </script>
</body>
</html>
